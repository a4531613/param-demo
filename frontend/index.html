<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å‚æ•°é…ç½®ä¸­å¿ƒ Â· Vue + Express + SQLite</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    :root {
      --bg: #0b1021;
      --panel: #0f172a;
      --card: #0f182f;
      --line: #1f2937;
      --primary: #38bdf8;
      --primary-2: #6366f1;
      --text: #e2e8f0;
      --muted: #94a3b8;
      --success: #34d399;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: "Segoe UI", "Helvetica Neue", Arial, sans-serif; background: radial-gradient(160% 120% at 10% 20%, #0f172a 0%, #0b1021 40%, #0a0d1c 100%); color: var(--text); }
    header { height: 56px; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; background: #0f172a; border-bottom: 1px solid var(--line); box-shadow: 0 4px 16px rgba(0,0,0,0.35); position: sticky; top: 0; z-index: 10; }
    header h1 { font-size: 18px; letter-spacing: 0.4px; margin: 0; }
    .brand { display: flex; align-items: center; gap: 10px; }
    .badge { padding: 4px 8px; border-radius: 999px; background: rgba(99,102,241,0.12); color: var(--primary-2); font-weight: 700; font-size: 12px; border: 1px solid rgba(99,102,241,0.4); }
    .layout { display: grid; grid-template-columns: 220px 1fr; min-height: calc(100vh - 56px); }
    nav { background: #0e162b; border-right: 1px solid var(--line); padding: 16px 12px; }
    nav .menu-title { color: var(--muted); font-size: 12px; letter-spacing: 0.6px; margin: 10px 12px 6px; text-transform: uppercase; }
    nav button { width: 100%; text-align: left; border: 1px solid transparent; background: transparent; color: var(--text); padding: 10px 12px; border-radius: 10px; margin-bottom: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; }
    nav button:hover { background: #111c34; border-color: #1f2937; }
    nav button.active { background: linear-gradient(120deg, rgba(56,189,248,0.12), rgba(99,102,241,0.18)); border-color: rgba(99,102,241,0.4); box-shadow: 0 6px 16px rgba(99,102,241,0.25); }
    main { padding: 18px; }
    .panel { background: var(--panel); border: 1px solid var(--line); border-radius: var(--radius); padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-bottom: 16px; }
    .panel h2 { margin: 0 0 10px; font-size: 16px; color: #cbd5ff; }
    .section-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 14px; }
    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    input, select, textarea { width: 100%; background: #0b1220; color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 8px 10px; margin-bottom: 10px; }
    textarea { min-height: 70px; }
    button.cta { background: linear-gradient(120deg, var(--primary), var(--primary-2)); border: none; color: #0b1220; font-weight: 700; padding: 9px 14px; border-radius: 9px; cursor: pointer; box-shadow: 0 6px 14px rgba(99,102,241,0.35); margin-right: 8px; }
    button.ghost { background: #111c34; border: 1px solid var(--line); color: var(--text); padding: 8px 12px; border-radius: 9px; cursor: pointer; }
    .list { border: 1px solid var(--line); border-radius: 10px; background: #0b1220; padding: 10px; max-height: 340px; overflow: auto; }
    .row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; }
    .card { border-bottom: 1px solid var(--line); padding: 8px 0; }
    .tag { padding: 3px 8px; border-radius: 7px; font-size: 11px; font-weight: 700; color: #0b1021; }
    .tag.success { background: var(--success); }
    .tag.warn { background: var(--warn); }
    .tag.draft { background: #cbd5ff; color: #0b1021; }
    .tag.pending { background: #f59e0b; }
    .tag.published { background: #34d399; }
    .stat { display: inline-flex; align-items: center; gap: 8px; padding: 4px 8px; border-radius: 8px; background: #111c34; border: 1px solid var(--line); margin-right: 8px; }
    .table { width: 100%; border-collapse: collapse; }
    .table th, .table td { border-bottom: 1px solid var(--line); padding: 8px 6px; text-align: left; }
    .table th { color: var(--muted); font-weight: 600; }
    .pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #1e293b; border: 1px solid #273449; margin-right: 6px; margin-bottom: 6px; font-size: 12px; }
    pre { background: #0b1220; border: 1px solid var(--line); padding: 12px; border-radius: 10px; overflow: auto; }
    .toast { position: fixed; right: 20px; bottom: 20px; background: #111c34; color: var(--text); padding: 10px 14px; border: 1px solid var(--line); border-radius: 10px; box-shadow: 0 10px 24px rgba(0,0,0,0.35); min-width: 220px; }
    @media (max-width: 960px) { .layout { grid-template-columns: 1fr; } nav { position: sticky; top: 56px; z-index: 9; } }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="badge">Param Center</div>
      <h1>å‚æ•°é…ç½®ä¸­å¿ƒ Â· Vue + Express + SQLite</h1>
    </div>
    <div style="color: var(--muted); font-size: 13px;">Demo ç”¨æˆ·ï¼š<strong>demo-user</strong></div>
  </header>
  <div class="layout" id="app">
    <nav>
      <div class="menu-title">ç®¡ç†èœå•</div>
      <button :class="{active: page==='users'}" @click="page='users'">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</button>
      <button :class="{active: page==='apps'}" @click="page='apps'">ğŸ§­ åº”ç”¨ç®¡ç†</button>
      <button :class="{active: page==='envs'}" @click="page='envs'">ğŸŒ ç¯å¢ƒç®¡ç†</button>
      <button :class="{active: page==='types'}" @click="page='types'">ğŸ—‚ é…ç½®ç±»å‹</button>
      <button :class="{active: page==='fields'}" @click="page='fields'">ğŸ”‘ ç±»å‹å­—æ®µ</button>
      <button :class="{active: page==='versions'}" @click="page='versions'">ğŸ“¦ ç‰ˆæœ¬ç®¡ç†</button>
      <button :class="{active: page==='items'}" @click="page='items'">ğŸ§¾ æ•°æ®ç»´æŠ¤</button>
      <button :class="{active: page==='audit'}" @click="page='audit'">ğŸ“œ å®¡è®¡æ—¥å¿—</button>
      <div class="menu-title">æ¶ˆè´¹</div>
      <button :class="{active: page==='fetch'}" @click="page='fetch'">ğŸ” é…ç½®æŸ¥è¯¢</button>
    </nav>
    <main>
      <!-- Users -->
      <div v-if="page==='users'" class="panel">
        <h2>ç”¨æˆ·ç®¡ç†</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åˆ›å»ºç”¨æˆ·</h3>
            <label>ç”¨æˆ·å</label><input v-model="forms.user.username" placeholder="alice">
            <label>æ˜¾ç¤ºå</label><input v-model="forms.user.displayName" placeholder="Alice Zhang">
            <label>è§’è‰²</label>
            <select v-model="forms.user.role">
              <option value="admin">admin</option>
              <option value="user">user</option>
            </select>
            <label>Email</label><input v-model="forms.user.email" placeholder="alice@example.com">
            <button class="cta" @click="createUser">åˆ›å»º</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">ç”¨æˆ·åˆ—è¡¨</h3>
            <div class="list">
              <div class="card" v-for="u in data.users" :key="u.user_id">
                <div><strong>{{ u.username }}</strong> <span class="pill">{{ u.role }}</span></div>
                <small>{{ u.display_name }} Â· {{ u.email || 'æ— é‚®ç®±' }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Applications -->
      <div v-if="page==='apps'" class="panel">
        <h2>åº”ç”¨ç®¡ç†</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åˆ›å»ºåº”ç”¨</h3>
            <label>App Code</label><input v-model="forms.app.appCode" placeholder="billing">
            <label>App åç§°</label><input v-model="forms.app.appName" placeholder="è®¡è´¹ç³»ç»Ÿ">
            <label>æè¿°</label><textarea v-model="forms.app.description"></textarea>
            <button class="cta" @click="createApp">åˆ›å»º</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åº”ç”¨åˆ—è¡¨</h3>
            <div class="list">
              <div class="card" v-for="a in data.apps" :key="a.app_id">
                <div><strong>{{ a.app_code }}</strong></div>
                <small>{{ a.app_name }} Â· {{ a.description || 'æ— æè¿°' }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Environments -->
      <div v-if="page==='envs'" class="panel">
        <h2>ç¯å¢ƒç®¡ç†</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åˆ›å»ºç¯å¢ƒ</h3>
            <label>App Code</label><input v-model="forms.env.appCode" placeholder="billing">
            <label>Env Code</label><input v-model="forms.env.envCode" placeholder="prod">
            <label>Env åç§°</label><input v-model="forms.env.envName" placeholder="ç”Ÿäº§ç¯å¢ƒ">
            <label>æè¿°</label><textarea v-model="forms.env.description"></textarea>
            <button class="cta" @click="createEnv">åˆ›å»º</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">ç¯å¢ƒåˆ—è¡¨</h3>
            <div class="list">
              <div class="card" v-for="e in data.envs" :key="e.env_id">
                <div><strong>{{ e.app_code }}</strong> Â· <span class="pill">{{ e.env_code }}</span></div>
                <small>{{ e.env_name }} Â· {{ e.description || 'æ— æè¿°' }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Config types -->
      <div v-if="page==='types'" class="panel">
        <h2>é…ç½®ç±»å‹ç®¡ç†</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åˆ›å»ºç±»å‹</h3>
            <div class="row">
              <div><label>App Code</label><input v-model="forms.type.appCode" placeholder="billing"></div>
              <div><label>Env Code</label><input v-model="forms.type.envCode" placeholder="dev"></div>
            </div>
            <div class="row">
              <div><label>Type Code</label><input v-model="forms.type.typeCode" placeholder="mysql"></div>
              <div><label>Type åç§°</label><input v-model="forms.type.typeName" placeholder="MySQL"></div>
            </div>
            <label>æè¿°</label><textarea v-model="forms.type.description"></textarea>
            <h4 style="margin:8px 0 4px;">å­—æ®µæ¨¡æ¿</h4>
            <div class="panel" style="margin:0; background:#0b1220; border:1px dashed var(--line);">
              <div class="card" v-for="(f, idx) in forms.type.fields" :key="idx">
                <div class="row">
                  <div><label>Key</label><input v-model="f.fieldKey" placeholder="host"></div>
                  <div><label>Name</label><input v-model="f.fieldName" placeholder="DB Host"></div>
                </div>
                <div class="row">
                  <div><label>ç±»å‹</label>
                    <select v-model="f.fieldType">
                      <option>string</option><option>int</option><option>boolean</option><option>json</option><option>secret</option>
                    </select>
                  </div>
                  <div><label>å¿…å¡«</label>
                    <select v-model="f.isRequired">
                      <option :value="true">true</option>
                      <option :value="false">false</option>
                    </select>
                  </div>
                </div>
                <div class="row">
                  <div><label>æ­£åˆ™</label><input v-model="f.regexPattern" placeholder="^\\S+$"></div>
                  <div><label>é»˜è®¤å€¼</label><input v-model="f.defaultValue"></div>
                </div>
                <button class="ghost" @click="removeField(idx)">ç§»é™¤</button>
              </div>
              <button class="ghost" @click="addField">+ æ·»åŠ å­—æ®µ</button>
            </div>
            <button class="cta" style="margin-top:10px;" @click="createType">åˆ›å»ºç±»å‹</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">ç±»å‹åˆ—è¡¨</h3>
            <div class="row">
              <div><label>App è¿‡æ»¤</label><input v-model="filters.type.appCode"></div>
              <div><label>Env è¿‡æ»¤</label><input v-model="filters.type.envCode"></div>
            </div>
            <button class="ghost" @click="loadTypes">åˆ·æ–°</button>
            <div class="list">
              <div class="card" v-for="t in data.types" :key="t.type_id">
                <div><span class="pill">{{ t.app_code }}</span><span class="pill">{{ t.env_code }}</span></div>
                <div><strong>{{ t.type_code }}</strong> Â· {{ t.type_name }}</div>
                <small>{{ t.description || 'æ— æè¿°' }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Fields -->
      <div v-if="page==='fields'" class="panel">
        <h2>é…ç½®ç±»å‹å­—æ®µç®¡ç†</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åŠ è½½å­—æ®µ</h3>
            <label>Type ID</label><input v-model="forms.field.typeId" placeholder="1">
            <button class="ghost" @click="loadFields">åŠ è½½</button>
            <h3 style="margin:14px 0 8px;">æ–°å¢å­—æ®µ</h3>
            <label>Field Key</label><input v-model="forms.field.fieldKey">
            <label>Field Name</label><input v-model="forms.field.fieldName">
            <label>Field Type</label>
            <select v-model="forms.field.fieldType">
              <option>string</option><option>int</option><option>boolean</option><option>json</option><option>secret</option>
            </select>
            <label>å¿…å¡«</label>
            <select v-model="forms.field.isRequired">
              <option :value="true">true</option><option :value="false">false</option>
            </select>
            <label>æ­£åˆ™</label><input v-model="forms.field.regexPattern">
            <label>é»˜è®¤å€¼</label><input v-model="forms.field.defaultValue">
            <label>æè¿°</label><textarea v-model="forms.field.description"></textarea>
            <button class="cta" @click="createField">åˆ›å»ºå­—æ®µ</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">å­—æ®µåˆ—è¡¨</h3>
            <div class="list">
              <div class="card" v-for="f in data.fields" :key="f.field_id">
                <div><strong>{{ f.field_key }}</strong> Â· {{ f.field_name }}</div>
                <small>{{ f.field_type }} | å¿…å¡«: {{ f.is_required ? 'æ˜¯' : 'å¦' }} | {{ f.description || 'æ— æè¿°' }}</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Versions -->
      <div v-if="page==='versions'" class="panel">
        <h2>ç‰ˆæœ¬ç®¡ç†</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åˆ›å»ºç‰ˆæœ¬</h3>
            <div class="row">
              <div><label>App Code</label><input v-model="forms.version.appCode"></div>
              <div><label>Env Code</label><input v-model="forms.version.envCode"></div>
            </div>
            <div class="row">
              <div><label>Type Code</label><input v-model="forms.version.typeCode"></div>
              <div><label>Version No</label><input v-model="forms.version.versionNo"></div>
            </div>
            <label>æè¿°</label><textarea v-model="forms.version.description"></textarea>
            <h4 style="margin:8px 0 4px;">ç‰ˆæœ¬å­—æ®µå€¼</h4>
            <div class="panel" style="margin:0; background:#0b1220; border:1px dashed var(--line);">
              <div class="card" v-for="(it, idx) in forms.version.items" :key="idx">
                <div class="row">
                  <div><label>Field Key</label><input v-model="it.fieldKey"></div>
                  <div><label>æ ¼å¼</label>
                    <select v-model="it.valueFormat">
                      <option>plain</option><option>json</option><option>secret</option>
                    </select>
                  </div>
                </div>
                <label>å€¼</label><textarea v-model="it.value"></textarea>
                <button class="ghost" @click="removeItem(idx)">ç§»é™¤</button>
              </div>
              <button class="ghost" @click="addItem">+ æ·»åŠ å­—æ®µå€¼</button>
            </div>
            <button class="cta" style="margin-top:10px;" @click="createVersion">åˆ›å»ºç‰ˆæœ¬</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">ç‰ˆæœ¬åˆ—è¡¨</h3>
            <div class="row">
              <div><label>App</label><input v-model="filters.version.appCode"></div>
              <div><label>Env</label><input v-model="filters.version.envCode"></div>
              <div><label>Type</label><input v-model="filters.version.typeCode"></div>
            </div>
            <button class="ghost" @click="loadVersions">åˆ·æ–°</button>
            <div class="list">
              <div class="card" v-for="v in data.versions" :key="v.version_id">
                <div><span class="pill">{{ v.app_code }}</span><span class="pill">{{ v.env_code }}</span><span class="pill">{{ v.type_code }}</span></div>
                <div style="display:flex; align-items:center; gap:8px;">
                  <strong>{{ v.version_no }}</strong>
                  <span class="tag" :class="v.status">{{ v.status }}</span>
                  <span v-if="v.is_current" class="tag success">current</span>
                </div>
                <small>ç”Ÿæ•ˆ: {{ v.effective_from || 'â€”' }}</small><br>
                <button class="cta" @click="publishVersion(v.version_id)">å‘å¸ƒ</button>
                <button class="ghost" @click="submitVersion(v.version_id)">æäº¤</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Data maintenance -->
      <div v-if="page==='items'" class="panel">
        <h2>æ•°æ®ç»´æŠ¤ï¼ˆé…ç½®é¡¹ï¼‰</h2>
        <div class="section-grid">
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">åŠ è½½ç‰ˆæœ¬é¡¹</h3>
            <label>Version ID</label><input v-model="forms.items.versionId" placeholder="1">
            <button class="ghost" @click="loadItems">åŠ è½½é¡¹</button>
          </div>
          <div class="panel" style="margin:0;">
            <h3 style="margin:0 0 8px;">ç»´æŠ¤é¡¹</h3>
            <div class="panel" style="margin:0; background:#0b1220; border:1px dashed var(--line);">
              <div class="card" v-for="(it, idx) in forms.items.items" :key="idx">
                <div class="row">
                  <div><label>Field Key</label><input v-model="it.fieldKey"></div>
                  <div><label>æ ¼å¼</label>
                    <select v-model="it.valueFormat">
                      <option>plain</option><option>json</option><option>secret</option>
                    </select>
                  </div>
                </div>
                <label>å€¼</label><textarea v-model="it.value"></textarea>
                <label>å¯ç”¨</label>
                <select v-model="it.isEnabled">
                  <option :value="true">true</option><option :value="false">false</option>
                </select>
                <button class="ghost" @click="removeMaintenanceItem(idx)">ç§»é™¤</button>
              </div>
              <button class="ghost" @click="addMaintenanceItem">+ æ·»åŠ é¡¹</button>
            </div>
            <button class="cta" style="margin-top:10px;" @click="upsertItems">ä¿å­˜</button>
          </div>
        </div>
      </div>

      <!-- Audit logs -->
      <div v-if="page==='audit'" class="panel">
        <h2>å®¡è®¡æ—¥å¿—</h2>
        <button class="ghost" @click="loadAudit">åˆ·æ–°</button>
        <table class="table">
          <thead>
            <tr><th>ID</th><th>Actor</th><th>Action</th><th>Target</th><th>Payload</th><th>æ—¶é—´</th></tr>
          </thead>
          <tbody>
            <tr v-for="log in data.audit" :key="log.log_id">
              <td>{{ log.log_id }}</td>
              <td>{{ log.actor }}</td>
              <td>{{ log.action }}</td>
              <td>{{ log.target_type }}#{{ log.target_id }}</td>
              <td><small>{{ pretty(log.payload) }}</small></td>
              <td><small>{{ log.created_at }}</small></td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Fetch config -->
      <div v-if="page==='fetch'" class="panel">
        <h2>é…ç½®æŸ¥è¯¢</h2>
        <div class="row">
          <div><label>App Code</label><input v-model="forms.fetch.appCode"></div>
          <div><label>Env Code</label><input v-model="forms.fetch.envCode"></div>
        </div>
        <div class="row">
          <div><label>Type Code</label><input v-model="forms.fetch.typeCode"></div>
          <div><label>Version No (å¯é€‰)</label><input v-model="forms.fetch.versionNo"></div>
        </div>
        <button class="cta" @click="fetchConfig">æŸ¥è¯¢</button>
        <pre>{{ fetchedConfig }}</pre>
      </div>
    </main>
  </div>

  <div class="toast" v-if="toast">{{ toast }}</div>

  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          apiBase: '/api',
          page: 'users',
          toast: '',
          data: { users: [], apps: [], envs: [], types: [], fields: [], versions: [], audit: [] },
          fetchedConfig: '',
          forms: {
            user: { username: '', displayName: '', role: 'admin', email: '' },
            app: { appCode: '', appName: '', description: '' },
            env: { appCode: '', envCode: '', envName: '', description: '' },
            type: { appCode: '', envCode: '', typeCode: '', typeName: '', description: '', fields: [] },
            field: { typeId: '', fieldKey: '', fieldName: '', fieldType: 'string', isRequired: true, regexPattern: '', defaultValue: '', description: '' },
            version: { appCode: '', envCode: '', typeCode: '', versionNo: '', description: '', items: [] },
            items: { versionId: '', items: [] },
            fetch: { appCode: '', envCode: '', typeCode: '', versionNo: '' }
          },
          filters: {
            type: { appCode: '', envCode: '' },
            version: { appCode: '', envCode: '', typeCode: '' }
          }
        };
      },
      methods: {
        async api(path, options = {}) {
          const res = await fetch(`${this.apiBase}${path}`, {
            headers: { 'Content-Type': 'application/json', 'X-User': 'demo-user' },
            ...options
          });
          if (!res.ok) {
            const text = await res.text();
            throw new Error(text || res.statusText);
          }
          return res.json();
        },
        notify(msg) {
          this.toast = msg;
          setTimeout(() => (this.toast = ''), 2500);
        },
        // Users
        async loadUsers() {
          this.data.users = await this.api('/users');
        },
        async createUser() {
          await this.api('/users', { method: 'POST', body: JSON.stringify(this.forms.user) });
          this.notify('ç”¨æˆ·åˆ›å»ºæˆåŠŸ');
          this.forms.user.username = ''; this.forms.user.displayName = ''; this.forms.user.email = '';
          this.loadUsers();
        },
        // Apps
        async loadApps() {
          this.data.apps = await this.api('/apps');
        },
        async createApp() {
          await this.api('/apps', { method: 'POST', body: JSON.stringify(this.forms.app) });
          this.notify('åº”ç”¨åˆ›å»ºæˆåŠŸ');
          this.loadApps();
        },
        // Envs
        async loadEnvs() {
          this.data.envs = await this.api('/envs');
        },
        async createEnv() {
          await this.api('/envs', { method: 'POST', body: JSON.stringify(this.forms.env) });
          this.notify('ç¯å¢ƒåˆ›å»ºæˆåŠŸ');
          this.loadEnvs();
        },
        // Types
        addField() { this.forms.type.fields.push({ fieldKey: '', fieldName: '', fieldType: 'string', isRequired: true, regexPattern: '', defaultValue: '' }); },
        removeField(idx) { this.forms.type.fields.splice(idx, 1); },
        async loadTypes() {
          const qs = new URLSearchParams();
          if (this.filters.type.appCode) qs.append('appCode', this.filters.type.appCode);
          if (this.filters.type.envCode) qs.append('envCode', this.filters.type.envCode);
          this.data.types = await this.api(`/types?${qs.toString()}`);
        },
        async createType() {
          await this.api('/types', { method: 'POST', body: JSON.stringify(this.forms.type) });
          this.notify('ç±»å‹åˆ›å»ºæˆåŠŸ');
          this.loadTypes();
        },
        // Fields
        async loadFields() {
          if (!this.forms.field.typeId) return this.notify('è¯·å¡«å†™ typeId');
          this.data.fields = await this.api(`/type-fields?typeId=${this.forms.field.typeId}`);
        },
        async createField() {
          await this.api('/type-fields', { method: 'POST', body: JSON.stringify(this.forms.field) });
          this.notify('å­—æ®µåˆ›å»ºæˆåŠŸ');
          this.loadFields();
        },
        // Versions
        addItem() { this.forms.version.items.push({ fieldKey: '', value: '', valueFormat: 'plain' }); },
        removeItem(idx) { this.forms.version.items.splice(idx, 1); },
        async loadVersions() {
          const qs = new URLSearchParams();
          if (this.filters.version.appCode) qs.append('appCode', this.filters.version.appCode);
          if (this.filters.version.envCode) qs.append('envCode', this.filters.version.envCode);
          if (this.filters.version.typeCode) qs.append('typeCode', this.filters.version.typeCode);
          this.data.versions = await this.api(`/versions?${qs.toString()}`);
        },
        async createVersion() {
          await this.api('/versions', { method: 'POST', body: JSON.stringify(this.forms.version) });
          this.notify('ç‰ˆæœ¬åˆ›å»ºæˆåŠŸ');
          this.loadVersions();
        },
        async publishVersion(id) {
          await this.api(`/versions/${id}/publish`, { method: 'POST', body: '{}' });
          this.notify('å·²å‘å¸ƒ');
          this.loadVersions();
        },
        async submitVersion(id) {
          await this.api(`/versions/${id}/submit`, { method: 'POST', body: '{}' });
          this.notify('å·²æäº¤');
          this.loadVersions();
        },
        // Items maintenance
        addMaintenanceItem() { this.forms.items.items.push({ fieldKey: '', value: '', valueFormat: 'plain', isEnabled: true }); },
        removeMaintenanceItem(idx) { this.forms.items.items.splice(idx, 1); },
        async loadItems() {
          if (!this.forms.items.versionId) return this.notify('è¯·å¡«å†™ versionId');
          const rows = await this.api(`/items?versionId=${this.forms.items.versionId}`);
          this.forms.items.items = rows.map(r => ({ fieldKey: r.field_key, value: r.field_value, valueFormat: r.value_format, isEnabled: !!r.is_enabled }));
        },
        async upsertItems() {
          await this.api('/items/upsert', { method: 'POST', body: JSON.stringify(this.forms.items) });
          this.notify('é…ç½®é¡¹å·²ä¿å­˜');
          this.loadItems();
        },
        // Audit
        async loadAudit() {
          this.data.audit = await this.api('/audit?limit=100');
        },
        // Fetch config
        async fetchConfig() {
          const qs = new URLSearchParams(this.forms.fetch);
          try {
            const data = await this.api(`/config?${qs.toString()}`);
            this.fetchedConfig = JSON.stringify(data, null, 2);
          } catch (e) {
            this.fetchedConfig = e.message;
          }
        },
        pretty(obj) {
          if (obj === null || obj === undefined) return '';
          if (typeof obj === 'string') return obj;
          try { return JSON.stringify(obj); } catch (e) { return String(obj); }
        }
      },
      mounted() {
        this.addField();
        this.addItem();
        this.addMaintenanceItem();
        this.loadUsers();
        this.loadApps();
        this.loadEnvs();
        this.loadTypes();
        this.loadVersions();
        this.loadAudit();
      }
    }).mount('#app');
  </script>
</body>
</html>
